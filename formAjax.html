<!DOCTYPE html>
<html>
<head lang="en">
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="">
  <meta name="author" content="">
  <style type="text/css">
  html { height: 100% }
  body { height: 100%; margin: 0; padding: 0 }
  #map-canvas { height: 100% }
  </style>
  <title>Query Interface</title>

  <!-- Bootstrap Core CSS -->
  <link href="style/css/bootstrap.min.css" rel="stylesheet">

  <!-- Custom CSS -->
  <link href="style/css/clean-blog.min.css" rel="stylesheet">

  <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCNsIktQ8a4Pnpg4_Lk4JSD6jd1uAdqe5g&sensor=false"></script>
  <link href="http://maxcdn.bootstrapcdn.com/font-awesome/4.1.0/css/font-awesome.min.css" rel="stylesheet" type="text/css">
  <link href='http://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic' rel='stylesheet' type='text/css'>
  <link href='http://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800' rel='stylesheet' type='text/css'>

</head>
<body>

  <!-- Navigation -->
  <nav class="navbar navbar-inverse  navbar-fixed-top">
      <div class="container-fluid">
          <!-- Brand and toggle get grouped for better mobile display -->
          <div class="navbar-header page-scroll">
              <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
                  <span class="sr-only">Toggle navigation</span>
                  <span class="icon-bar"></span>
                  <span class="icon-bar"></span>
                  <span class="icon-bar"></span>
              </button>
              <a class="navbar-brand" href="formAjax.html">Football Knowitalls</a>
          </div>

          <!-- Collect the nav links, forms, and other content for toggling -->
          <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
              <ul class="nav navbar-nav navbar-right">
                  <li>
                      <a href="formAjax.html">Home</a>
                  </li>
                  <li>
                      <a href="about.html">Search Engine</a>
                  </li>
                  <li>
                      <a href="post.html">About</a>
                  </li>
                  <li>
                      <a href="contact.html">Contact</a>
                  </li>
              </ul>
          </div>
          <!-- /.navbar-collapse -->
      </div>
      <!-- /.container -->
  </nav>

  <!-- Page Header -->
  <!-- Set your background image for this header on the line below. -->
  <header class="intro-header" style="background-image: url('style/img/home-bg.jpg')">
      <div class="container">
          <div class="row">
              <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                 <div class="site-heading">
                   <!-- <hr class="small">
                     <span class="subheading"></span>
                  </div>  -->
              </div>
          </div>
      </div>
  </header>
<!--
  <div class="container">
      <div class="row">
          <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"> -->
 <div align="center">
    <form id="myForm" onsubmit="return false;">
      <input type="text" name="teamname" placeholder="Team Name">
      <br>
      <input type="checkbox" name= "checktweet1"> Tweets
      <input type="checkbox" name= "checkmentions1"> Mentions
      <br><br>
      <input type="text" name="playername" placeholder="Player Name">
      <br>
      <input type="checkbox" name="checktweet2"> Tweets
      <input type="checkbox" name="checkmentions2"> Mentions
      <br><br>
      <input type="Text" name="hashtag" placeholder="Search Trending Hastags">
      <br><br>
      <input type="Text" name="keyword" placeholder="Search via keywords">
      <br><br>
      <button id="sendButton">Send Data</button>

    </form>

      <div class="map"></div>
    <div id="plxwork": style="width: 50%; height: 500px; border: 50px invisible;  overflow-y: auto;">
</div>
<div id="plxwork2": style="width: 50%; height: 500px; float:left; overflow-y: auto;">
</div>
<div id="plxwork3": style="width: 50%; height: 500px; float:right; overflow-y: auto;">
</div>
<div id="plxwork4": style="width: 50%; height: 500px; float: top-left; ">
</div>

    </div>
    <script>
    function sendAjaxQuery(url, data) {
      $.ajax({
        type: 'POST',
        url: 'postFile.html',
        data: data,
        dataType:'json',
        success: function (data) {
          var tweetsA = [];
            for (index in data){
               tweetsA.push(data[index].text)

               if (data[index] !== 'undefined'){
             var x = "<img src = '"+data[index].user.profile_image_url+"'>";
             $("#plxwork").append("<p>"+"AUTHOR: "+x+data[index].user.name+"   "+"@"+data[index].user.screen_name+"</p>")
             $("#plxwork").append("<p>"+"TWEET: "+"  "+data[index].text+"</p>")
                   }
                   }

            function sortObject (mydict) {

              var keys = [];
              var arr = [];
              for(var key in mydict) {
                arr.push({key:key, val: mydict[key]})
              }

              arr.sort(function(a, b) {
                return b.val - a.val;
              })

              for (i=0; i<10; i++){
                if (typeof arr[i] != 'undefined' ){
                  keys = keys.concat(arr[i])
                }

              }
              return keys
            }

            var mostFrequentWords = [];
                    var frequentWords = [];
                    var activeUsers = []; //an array of all the users in all the retrieved tweet
                    var mostActiveUsers = {}; //an object of the top 10 most active users and their frequency
                    var regex = /\B@\w+/gi; //regular expression to extract all the words containing @
                    var regex1 = /\w+/gi; //regex to extract all non words symbol

                    for ( i = 0 ; i < tweetsA.length; i++) { //tweetsA is a list of all the retrieved tweets as a string
                      /* loop through all the retrieved tweets and extract the all the active users*/
                      while((m = regex.exec(tweetsA[i])) != null) {
                        activeUsers = activeUsers.concat(m[0]);
                      }
                      while((j = regex1.exec(tweetsA[i])) != null) {
                        frequentWords = frequentWords.concat(j[0]);
                      }
                    }

                    // var stopWords = ["https", "http", "t", "co", "s", "i", "an", "it"]
                    //
                    // for (i=0; i< frequentWords.length; i++){
                    //    for (j=0; j<stopWords.length; j++){
                    //       if(frequentWords[i].indexOf(stopWords[j].key) !== -1) {
                    //          frequentWords = frequentWords[i].replace(stopWords[j],' ');
                    //        }
                    //    }
                    // }

                    /* loop through all the retrieved tweets and remove any punctuations and hashtag
                    and return an array of the retrieved tweets */
                    var arrayOfTweets = tweetsA.map(function (str) {
                      return str.replace(regex1, '');
                    });


                    /* loop through all active users in from retrieved tweets, then compute a frequency
                    of all the active users */
                    for (i = 0; i < activeUsers.length; i++){
                      if (activeUsers[i] in mostActiveUsers){
                        mostActiveUsers[activeUsers[i]] += 1
                      }else{
                        mostActiveUsers[activeUsers[i]] = 1
                      }
                    }

                    for (i = 0; i < frequentWords.length; i++){
                      if (frequentWords[i] in mostFrequentWords){
                        mostFrequentWords[frequentWords[i]] += 1
                      }else{
                        mostFrequentWords[frequentWords[i]] = 1
                      }
                    }


                    mostActiveUsers = sortObject(mostActiveUsers); //sort the most active users by frequency and retrieve the top 10
                    mostFrequentWords = sortObject(mostFrequentWords)

                    for (i in mostActiveUsers){
                      $("#plxwork2").append("<p>"+mostActiveUsers[i].key+  "   "  +mostActiveUsers[i].val+" tweets" +"</p>")
                    }

                    for (i in mostFrequentWords){
                      $("#plxwork3").append("<p>"+mostFrequentWords[i].key+  ":    "  +mostFrequentWords[i].val+"</p>")
                    }

            var mapp = [];
            //Here we process the tweet information getting the bits we need for the map generation

            function initialize(){
              for (index in data){
                for (var i in data[index].coordinates)
                //This is to ensure the tweets we are getting contain geo coordinates
                if (data[index].geo != 'null'){
                  mapp.push(data[index].coordinates[i])
                }
              }


              var lat = mapp[1][1]
              var lng = mapp[1][0]
              var myLatlng = new google.maps.LatLng(lat, lng);
              var mapOptions = { center: myLatlng, zoom: 17 }
              map = new google.maps.Map(document.getElementById("map-canvas"),  mapOptions);
              for (i =0; i < mapp.length-1; i+=2){
                for (j=0; j <mapp[i+1].length - 1; j++){


                  var markers = [];
                  //The Latitude and longitude for each tweet is taking from the coordinates of
                  //tweet if it is geo tagged.
                  var myLatlng2 = new google.maps.LatLng(mapp[i+1][j+1], mapp[i+1][j]);
                  //For each tweet create a marker and then add the marker to an array of markers
                  // and update/position the map
                  var marker = new google.maps.Marker({
                    id: i,
                    position: myLatlng2,
                    map: map,
                    title: '@' + data[index].user.screen_name + ':' + data[index].text,
                    icon: {
                      url: data[index].user.profile_image_url,
                      size: new google.maps.Size(64, 64),
                      origin: new google.maps.Point(0, 0),
                      anchor: new google.maps.Point(32, 32),
                      scaledSize: new google.maps.Size(40, 40)
                    }
                  });
                  //markers.push(marker);
                  var infowindow = new google.maps.InfoWindow({
                    content: data[i].text,
                    maxWidth: 200
                  });
                  infowindow.open(map, marker);
                  google.maps.event.addListener(marker, 'click', function() {
                    infowindow.open(map, marker);
                  });

                }
              }
            }
            google.maps.event.addDomListener(window, 'load', initialize());

          },
          error: function (xhr, status, error) {
            console.log('Error: ' + error.message);
            alert('error connecting');
          }
        });
      }
      $.fn.serializeObject = function () {
        var o = {};
        var a = this.serializeArray();
        $.each(a, function () {
          if (o[this.name] !== undefined) {
            if (!o[this.name].push) {
              o[this.name] = [o[this.name]];
            }
            o[this.name].push(this.value || '');
          } else {
            o[this.name] = this.value || '';
          }
        });
        return o;
      };
      function sendData() {
        var form = document.getElementById('myForm');
        sendAjaxQuery('http://localhost:3000/', JSON.stringify($('form').serializeObject()));
      }
      var sendButton = document.getElementById('sendButton');
      sendButton.onclick = sendData;
      </script>
    </head>
    <body>
      <div align="center">
      <div id="map-canvas" style="background-color:#FFFFFF;width:50%;height:300pt;align:center; "/>
      </div>
    </body>
    </html>
